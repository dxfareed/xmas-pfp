# Agent Guide: Farcaster Share Frame Implementation

This guide provides a detailed explanation of how the Farcaster share frame functionality is implemented in this project. It is intended for agents to understand the underlying logic and be able to replicate or extend it.

## Overview

The share frame feature allows users to share a dynamically generated image on Farcaster. The process involves two main components:

1.  A page that generates the Farcaster frame metadata.
2.  An API route that generates the image for the frame.

## The Flow

The share frame flow is initiated when a user shares a URL in a Farcaster cast. The URL is structured as follows:

```
https://<your-app-url>/share-frame/generated?imageUrl=<image-url>
```

When a Farcaster client encounters this URL, it makes a request to the page and parses the HTML for frame metadata.

### 1. Frame Metadata Generation

The frame metadata is generated by the `app/share-frame/generated/page.tsx` file. This file does not render a visible page in the browser; instead, its primary purpose is to generate the necessary `<meta>` tags for the Farcaster frame.

#### `generateMetadata` Function

The core of this file is the `generateMetadata` function. It receives the `imageUrl` from the search parameters and uses it to construct the frame metadata.

Key steps:

1.  **Get `imageUrl`:** The `imageUrl` is extracted from the `searchParams`.
2.  **Construct Frame Image URL:** A dynamic `frameImageUrl` is created, pointing to our API route (`/api/frame-image/generated`). The original `imageUrl` is passed as a query parameter to this URL.
3.  **Define Button Action:** A button is defined with a `launch_frame` action, which directs the user to the main application URL when clicked.
4.  **Return Metadata:** The function returns a `Metadata` object containing the Farcaster frame metadata.

#### The `fc:frame` Content

A crucial part of the metadata generation is the construction of the JSON object that will be the content of the `fc:frame` meta tag. This approach is part of the latest Farcaster frame specification.

```ts
const fcFrameContent = JSON.stringify({
    version: minikitConfig.frame.version,
    imageUrl: frameImageUrl.toString(),
    button: {
      title: `Generate Religious Warplet`,
      action: {
        name: `Generate ${minikitConfig.frame.name}`,
        type: "launch_frame",
        target: launchUrl,
      },
    },
  });
```

Let's break down this object:

*   **`version`**: Specifies the Farcaster frame version being used (e.g., `vNext`).
*   **`imageUrl`**: This is the dynamically generated URL pointing to our image generation API route (`app/api/frame-image/generated/route.tsx`). The Farcaster client will fetch this URL to display the frame's image.
*   **`button`**: An object defining the interactive button within the frame.
    *   **`title`**: The text that appears on the button (e.g., "Generate Religious Warplet").
    *   **`action`**: An object specifying what happens when the button is clicked.
        *   **`name`**: A descriptive name for the action.
        *   **`type`**: The type of action. In this case, `"launch_frame"` tells the Farcaster client to open a mini-app.
        *   **`target`**: The URL of the mini-app to be launched.

This JSON object is then stringified and placed in the `content` attribute of a `<meta name="fc:frame" ... />` tag in the page's `<head>`.

### 2. Frame Image Generation

The image for the frame is generated by the `app/api/frame-image/generated/route.tsx` API route. This route is responsible for creating the visual representation of the frame.

#### `GET` Handler

The `GET` handler in this route performs the following actions:

1.  **Get `imageUrl`:** The `imageUrl` is extracted from the query parameters of the request.
2.  **Fetch Image:** The image is fetched from the provided `imageUrl`. The code includes logic to handle both standard URLs and IPFS URIs.
3.  **Convert to Data URL:** The fetched image is converted into a base64-encoded data URL. This is necessary to embed the image directly into the generated `ImageResponse`.
4.  **Create `ImageResponse`:** The `ImageResponse` object is created using `next/og`. This object defines the JSX structure of the image to be generated.
    *   **Image Display:** The fetched image (as a data URL) is embedded in an `<img>` tag.
    *   **Custom Font:** The `W95FA` custom font is loaded and applied to the text in the image.
    *   **Text Overlay:** A text overlay is added to the bottom of the image.
5.  **Return Image:** The `ImageResponse` is returned, which sends the generated image back to the Farcaster client.

## Summary

In essence, the share frame functionality is a two-step process:

1.  A page that serves the Farcaster frame metadata, pointing to an image-generation API route.
2.  An API route that dynamically generates an image based on the parameters passed to it.

This separation of concerns allows for a flexible and powerful way to create dynamic and shareable content on Farcaster.
